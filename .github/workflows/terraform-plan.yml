name: Terraform Plan

on:
  pull_request:
    branches:
      - main
    paths:
      - "inf/terraform/**/*.tf"
      - "inf/terraform/**/*.tfvars"
      - ".github/workflows/terraform-plan.yml"
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to plan"
        required: true
        type: choice
        options:
          - staging
          - production
      directory:
        description: "Terraform project name (e.g., aws-s3-web, aws-github-oidc)"
        required: true
        type: string

# Default permissions: read-only (security-first)
permissions:
  contents: read
  pull-requests: write # For PR comments
  id-token: write # For OIDC authentication

env:
  TERRAFORM_VERSION: "1.9.8"

# Prevent concurrent plans for the same environment
concurrency:
  group: terraform-plan-${{ github.event.inputs.environment || 'pr' }}-${{ github.event.inputs.directory || 'all' }}
  cancel-in-progress: false # Don't cancel in-progress plans

jobs:
  # =============================================================================
  # Job 1: Detect Changes and Set Up Matrix
  # =============================================================================
  setup:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has-changes: ${{ steps.set-matrix.outputs.has-changes }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up planning matrix
        id: set-matrix
        run: |
          # Auto-discover all Terraform project directories in inf/terraform/
          echo "üîç Discovering Terraform projects in inf/terraform/ directory..."
          TERRAFORM_DIRS=()
          while IFS= read -r dir; do
            project_name="$(basename "$dir")"
            TERRAFORM_DIRS+=("$project_name")
          done < <(find inf/terraform -mindepth 1 -maxdepth 1 -type d | sort -u)

          if [ ${#TERRAFORM_DIRS[@]} -eq 0 ]; then
            echo "‚ö†Ô∏è No Terraform projects found in inf/"
            echo "has-changes=false" >> $GITHUB_OUTPUT
            echo "matrix=[]" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "üìÅ Discovered Terraform projects: ${TERRAFORM_DIRS[*]}"

          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Manual trigger - plan specific environment and directory
            ENVIRONMENT="${{ github.event.inputs.environment }}"
            DIRECTORY="${{ github.event.inputs.directory }}"
            
            # Validate directory exists
            if [ ! -d "inf/terraform/$DIRECTORY" ]; then
              echo "‚ùå Directory inf/terraform/$DIRECTORY does not exist"
              echo "Available directories: ${TERRAFORM_DIRS[*]}"
              exit 1
            fi
            
            MATRIX="[{\"environment\":\"$ENVIRONMENT\",\"directory\":\"$DIRECTORY\"}]"
            echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
            echo "has-changes=true" >> $GITHUB_OUTPUT
            echo "üìã Planning: $DIRECTORY ($ENVIRONMENT)"
          else
            # PR trigger - detect changes and plan affected environments
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
            CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA)
            
            # Build matrix for all changed directories with their environments
            MATRIX="[]"
            
            for dir in "${TERRAFORM_DIRS[@]}"; do
              if echo "$CHANGED_FILES" | grep -q "^inf/terraform/$dir/"; then
                echo "üìù Changes detected in: $dir"
                
                # Detect available environments for this directory
                ENVS=()
                if [ -d "inf/terraform/$dir/environments" ]; then
                  for tfvars in inf/terraform/$dir/environments/*.tfvars; do
                    if [ -f "$tfvars" ]; then
                      env_name=$(basename "$tfvars" .tfvars)
                      ENVS+=("$env_name")
                    fi
                  done
                fi
                
                # If no environment files found, use a default
                if [ ${#ENVS[@]} -eq 0 ]; then
                  ENVS=("default")
                fi
                
                # Add each environment to the matrix
                for env in "${ENVS[@]}"; do
                  MATRIX=$(echo $MATRIX | jq -c --arg dir "$dir" --arg env "$env" '. + [{"environment":$env,"directory":$dir}]')
                done
              fi
            done
            
            echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
            
            if [ "$MATRIX" != "[]" ]; then
              echo "has-changes=true" >> $GITHUB_OUTPUT
              echo "üîç Will plan: $(echo $MATRIX | jq -r '.[] | "\(.directory) (\(.environment))"' | tr '\n' ' ')"
            else
              echo "has-changes=false" >> $GITHUB_OUTPUT
              echo "‚ÑπÔ∏è No Terraform changes detected"
            fi
          fi

  # =============================================================================
  # Job 2: Terraform Plan for Each Environment
  # =============================================================================
  plan:
    name: Plan ${{ matrix.directory }} (${{ matrix.environment }})
    needs: setup
    if: needs.setup.outputs.has-changes == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.setup.outputs.matrix) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Cache Terraform providers
        uses: actions/cache@v5
        with:
          path: inf/terraform/${{ matrix.directory }}/.terraform
          key: ${{ runner.os }}-terraform-${{ matrix.directory }}-${{ hashFiles(format('inf/terraform/{0}/.terraform.lock.hcl', matrix.directory)) }}
          restore-keys: |
            ${{ runner.os }}-terraform-${{ matrix.directory }}-

      - name: Terraform Init
        working-directory: inf/terraform/${{ matrix.directory }}
        run: |
          echo "üîß Initializing Terraform for ${{ matrix.environment }}..."
          terraform init -input=false
        continue-on-error: true

      - name: Select or Create Workspace
        working-directory: inf/terraform/${{ matrix.directory }}
        run: |
          echo "üìÇ Managing workspace: ${{ matrix.environment }}"
          terraform workspace select ${{ matrix.environment }} || terraform workspace new ${{ matrix.environment }}
          terraform workspace show

      - name: Terraform Plan
        id: plan
        working-directory: inf/terraform/${{ matrix.directory }}
        run: |
          echo "üìã Creating Terraform plan for ${{ matrix.environment }}..."

          # Check if tfvars file exists
          TFVARS_FILE="environments/${{ matrix.environment }}.tfvars"
          if [ -f "$TFVARS_FILE" ]; then
            echo "Using variables from $TFVARS_FILE"
            terraform plan -var-file="$TFVARS_FILE" -input=false -no-color -out=tfplan-${{ matrix.environment }} | tee plan-output.txt
          else
            echo "No tfvars file found at $TFVARS_FILE, using defaults"
            terraform plan -input=false -no-color -out=tfplan-${{ matrix.environment }} | tee plan-output.txt
          fi

          # Extract plan summary
          PLAN_SUMMARY=$(grep -E "Plan:|No changes" plan-output.txt | tail -1)
          echo "plan_summary=$PLAN_SUMMARY" >> $GITHUB_OUTPUT

          echo "‚úÖ Plan completed successfully"
        continue-on-error: true

      - name: Upload Plan Artifact
        if: steps.plan.outcome == 'success'
        uses: actions/upload-artifact@v6
        with:
          name: tfplan-${{ matrix.directory }}-${{ matrix.environment }}-${{ github.run_number }}
          path: |
            inf/terraform/${{ matrix.directory }}/tfplan-${{ matrix.environment }}
            inf/terraform/${{ matrix.directory }}/plan-output.txt
          retention-days: 30

      - name: Comment Plan Summary on PR
        if: github.event_name == 'pull_request' && steps.plan.outcome == 'success'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const planOutput = fs.readFileSync('inf/terraform/${{ matrix.directory }}/plan-output.txt', 'utf8');
            const planSummary = planOutput.split('\n').slice(-50).join('\n');  // Last 50 lines

            const output = `### Terraform Plan: \`${{ matrix.directory }}\` (\`${{ matrix.environment }}\`)

            #### üìã Plan Summary
            \`\`\`
            ${{ steps.plan.outputs.plan_summary }}
            \`\`\`

            <details><summary>üìÑ Show Plan Details (last 50 lines)</summary>

            \`\`\`terraform
            ${planSummary}
            \`\`\`

            </details>

            **Environment:** \`${{ matrix.environment }}\`  
            **Workflow:** \`${{ github.workflow }}\`  
            **Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})  
            **Commit:** \`${{ github.sha }}\`

            ---

            üí° **Next Steps:**
            - Review the plan carefully
            - Download the plan artifact for detailed inspection
            - If approved, the plan can be applied after merge
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

      - name: Handle Plan Failure
        if: steps.plan.outcome == 'failure'
        run: |
          echo "‚ùå Terraform plan failed for ${{ matrix.directory }} (${{ matrix.environment }})"
          echo "Please review the logs above for details."
          exit 1

  # =============================================================================
  # Job 3: Plan Summary
  # =============================================================================
  summary:
    name: Planning Summary
    needs: [setup, plan]
    if: always() && needs.setup.outputs.has-changes == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Generate Summary
        run: |
          echo "# üìã Terraform Planning Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üéØ Planning Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Plan Execution | ${{ needs.plan.result == 'success' && '‚úÖ Successful' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.plan.result }}" == "success" ]]; then
            echo "## ‚úÖ All Plans Generated Successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Plan artifacts have been uploaded and are available for review." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üì¶ Artifacts" >> $GITHUB_STEP_SUMMARY
            echo "- Plan files are saved with 30-day retention" >> $GITHUB_STEP_SUMMARY
            echo "- Download artifacts from the workflow run page" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ‚ùå Planning Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please review the job logs for detailed error information." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üìã Workflow Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Actor:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
