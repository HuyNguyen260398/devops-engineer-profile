name: Terraform Validation

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - "inf/**/*.tf"
      - "inf/**/*.tfvars"
      - "inf/**/*.tfvars.example"
      - ".github/workflows/terraform-validation.yml"
  push:
    branches:
      - main
      - develop
    paths:
      - "inf/**/*.tf"
      - "inf/**/*.tfvars"
      - "inf/**/*.tfvars.example"
      - ".github/workflows/terraform-validation.yml"
  workflow_dispatch:

# Default permissions: read-only (security-first)
permissions:
  contents: read
  pull-requests: write  # For PR comments with plan output
  id-token: write       # For OIDC authentication with AWS (if needed)
  security-events: write  # For uploading SARIF results

env:
  TERRAFORM_VERSION: "1.7.0"
  TFLINT_VERSION: "v0.50.3"
  TFSEC_VERSION: "v1.28.5"
  CHECKOV_VERSION: "3.2.0"

# Prevent concurrent runs on the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # =============================================================================
  # Job 1: Detect Changed Terraform Directories
  # =============================================================================
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      directories: ${{ steps.set-matrix.outputs.directories }}
      has-changes: ${{ steps.set-matrix.outputs.has-changes }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1
        with:
          fetch-depth: 0  # Need full history to detect changes

      - name: Detect changed Terraform directories
        id: set-matrix
        run: |
          # Define all Terraform directories
          TERRAFORM_DIRS=("aws-eks" "aws-github-oidc" "aws-s3-web")
          
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # For PRs, detect changes
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
            CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA)
          else
            # For push events, check all directories
            CHANGED_FILES=$(find inf -name "*.tf" -o -name "*.tfvars" 2>/dev/null || echo "")
          fi
          
          # Filter directories with changes
          CHANGED_DIRS=()
          for dir in "${TERRAFORM_DIRS[@]}"; do
            if echo "$CHANGED_FILES" | grep -q "^inf/$dir/"; then
              CHANGED_DIRS+=("$dir")
            fi
          done
          
          # If no specific changes detected or it's a manual trigger, validate all
          if [ ${#CHANGED_DIRS[@]} -eq 0 ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            CHANGED_DIRS=("${TERRAFORM_DIRS[@]}")
          fi
          
          # Convert to JSON array for matrix
          MATRIX_JSON=$(printf '%s\n' "${CHANGED_DIRS[@]}" | jq -R . | jq -s -c .)
          echo "directories=$MATRIX_JSON" >> $GITHUB_OUTPUT
          
          if [ ${#CHANGED_DIRS[@]} -gt 0 ]; then
            echo "has-changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ” Will validate: ${CHANGED_DIRS[*]}"
          else
            echo "has-changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No Terraform changes detected"
          fi

  # =============================================================================
  # Job 2: Terraform Format Check
  # =============================================================================
  terraform-fmt:
    name: Format Check (${{ matrix.directory }})
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        directory: ${{ fromJson(needs.detect-changes.outputs.directories) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@a1502cd9e758c50496cc9ac5308c4843bcd56d36  # v3.0.0
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Format Check
        id: fmt
        working-directory: inf/${{ matrix.directory }}
        run: |
          echo "ðŸ” Checking Terraform formatting..."
          terraform fmt -check -recursive -diff
          FMT_EXIT_CODE=$?
          
          if [ $FMT_EXIT_CODE -eq 0 ]; then
            echo "âœ… All files are properly formatted"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Formatting issues detected. Run 'terraform fmt -recursive' to fix."
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

  # =============================================================================
  # Job 3: TFLint (Terraform Linting)
  # =============================================================================
  tflint:
    name: TFLint (${{ matrix.directory }})
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        directory: ${{ fromJson(needs.detect-changes.outputs.directories) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1

      - name: Cache TFLint plugins
        uses: actions/cache@13aacd865c20de90d75de3b17ebe84f7a17d57d2  # v4.0.0
        with:
          path: ~/.tflint.d/plugins
          key: ${{ runner.os }}-tflint-${{ hashFiles('**/.tflint.hcl') }}
          restore-keys: |
            ${{ runner.os }}-tflint-

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@19a52fbac37dacde736cd9f9af9499e3b7d335c8  # v4.0.0
        with:
          tflint_version: ${{ env.TFLINT_VERSION }}

      - name: Initialize TFLint
        working-directory: inf/${{ matrix.directory }}
        run: |
          echo "ðŸ”§ Initializing TFLint..."
          tflint --init

      - name: Run TFLint
        working-directory: inf/${{ matrix.directory }}
        run: |
          echo "ðŸ” Running TFLint..."
          tflint --format=compact --recursive

  # =============================================================================
  # Job 4: Terraform Validate
  # =============================================================================
  terraform-validate:
    name: Validate (${{ matrix.directory }})
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        directory: ${{ fromJson(needs.detect-changes.outputs.directories) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@a1502cd9e758c50496cc9ac5308c4843bcd56d36  # v3.0.0
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Cache Terraform providers
        uses: actions/cache@13aacd865c20de90d75de3b17ebe84f7a17d57d2  # v4.0.0
        with:
          path: inf/${{ matrix.directory }}/.terraform
          key: ${{ runner.os }}-terraform-${{ matrix.directory }}-${{ hashFiles(format('inf/{0}/.terraform.lock.hcl', matrix.directory)) }}
          restore-keys: |
            ${{ runner.os }}-terraform-${{ matrix.directory }}-

      - name: Terraform Init
        working-directory: inf/${{ matrix.directory }}
        run: |
          echo "ðŸ”§ Initializing Terraform..."
          terraform init -backend=false -input=false
        env:
          TF_LOG: INFO

      - name: Terraform Validate
        working-directory: inf/${{ matrix.directory }}
        run: |
          echo "âœ… Validating Terraform configuration..."
          terraform validate -no-color

  # =============================================================================
  # Job 5: tfsec Security Scanning
  # =============================================================================
  tfsec:
    name: tfsec (${{ matrix.directory }})
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        directory: ${{ fromJson(needs.detect-changes.outputs.directories) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1

      - name: Run tfsec
        uses: aquasecurity/tfsec-action@b466648d6e39e7c75324f25d83891162a721f2d6  # v1.0.3
        with:
          working_directory: inf/${{ matrix.directory }}
          soft_fail: false  # Fail the build on security issues
          format: sarif
          additional_args: --minimum-severity MEDIUM

      - name: Upload tfsec SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@e8893c57a1f3a2b659b6b55564fdfdbbd2982911  # v3.24.0
        with:
          sarif_file: results.sarif
          category: tfsec-${{ matrix.directory }}

  # =============================================================================
  # Job 6: Checkov Security & Compliance Scanning
  # =============================================================================
  checkov:
    name: Checkov (${{ matrix.directory }})
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        directory: ${{ fromJson(needs.detect-changes.outputs.directories) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1

      - name: Set up Python
        uses: actions/setup-python@0a5c61591373683505ea898e09a3ea4f39ef2b9c  # v5.0.0
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install Checkov
        run: |
          pip install checkov==${{ env.CHECKOV_VERSION }}

      - name: Run Checkov
        working-directory: inf/${{ matrix.directory }}
        run: |
          echo "ðŸ” Running Checkov security scan..."
          checkov --directory . \
            --framework terraform \
            --compact \
            --quiet \
            --output cli \
            --output sarif \
            --output-file-path /tmp/checkov-results
        continue-on-error: true  # Don't fail build, just report

      - name: Upload Checkov SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@e8893c57a1f3a2b659b6b55564fdfdbbd2982911  # v3.24.0
        with:
          sarif_file: /tmp/checkov-results/results_sarif.sarif
          category: checkov-${{ matrix.directory }}

  # =============================================================================
  # Job 7: Summary Report
  # =============================================================================
  summary:
    name: Validation Summary
    needs: 
      - detect-changes
      - terraform-fmt
      - tflint
      - terraform-validate
      - tfsec
      - checkov
    if: always() && needs.detect-changes.outputs.has-changes == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Generate Summary
        run: |
          echo "# ðŸ—ï¸ Terraform Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Format Check | ${{ needs.terraform-fmt.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TFLint | ${{ needs.tflint.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform Validate | ${{ needs.terraform-validate.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| tfsec Security | ${{ needs.tfsec.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Checkov Compliance | ${{ needs.checkov.result == 'success' && 'âœ… Passed' || 'âš ï¸ Review Needed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Workflow Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Actor:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Determine overall status
          if [[ "${{ needs.terraform-fmt.result }}" == "success" ]] && \
             [[ "${{ needs.tflint.result }}" == "success" ]] && \
             [[ "${{ needs.terraform-validate.result }}" == "success" ]] && \
             [[ "${{ needs.tfsec.result }}" == "success" ]]; then
            echo "## âœ… Overall Status: PASSED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All critical validation checks passed successfully!" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Overall Status: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "One or more validation checks failed. Please review the logs above." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi