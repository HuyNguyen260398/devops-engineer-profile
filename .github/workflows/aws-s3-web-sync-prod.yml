name: Deploy to Production S3

on:
  push:
    branches:
      - main
    paths:
      - "src/aws-s3-web/**"

  pull_request:
    types: [closed]
    branches:
      - main
    paths:
      - "src/aws-s3-web/**"

  workflow_dispatch:
    inputs:
      reason:
        description: "Reason for manual deployment"
        required: false
        default: "Manual deployment triggered"
        type: string

permissions:
  id-token: write

env:
  PYTHON_VERSION: "3.11"
  S3_BUCKET: "s3.huyng.link"

jobs:
  run_job_with_aws:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@main # Or a specific version
        with:
          role-to-assume: arn:aws:iam::010382427026:role/github-actions-s3-sync-role
          aws-region: ap-southeast-1

      - name: Additional steps
        run: |
          # Your commands that require AWS credentials
          aws sts get-caller-identity

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
          cache-dependency-path: "dep-web-inf/lambda_scripts/lambda_requirements.txt"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install boto3 requests

      - name: Sync src/aws-s3-web to S3 Bucket
        id: sync
        run: |
          echo "Starting S3 sync at $(date)" | tee -a workflow.log

          aws s3 sync src/aws-s3-web/ s3://${{ env.S3_BUCKET }}/ \
            --delete \
            --exclude ".git/*" \
            --cache-control "public, max-age=3600" 2>&1 | tee -a workflow.log

          SYNC_EXIT_CODE=${PIPESTATUS[0]}

          if [ $SYNC_EXIT_CODE -eq 0 ]; then
            echo "âœ… Successfully synced src/aws-s3-web to s3://${{ env.S3_BUCKET }}" | tee -a workflow.log
            echo "sync_status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Sync failed with exit code $SYNC_EXIT_CODE" | tee -a workflow.log
            echo "sync_status=failed" >> $GITHUB_OUTPUT
            exit $SYNC_EXIT_CODE
          fi

          echo "Completed at $(date)" | tee -a workflow.log

      - name: Generate Workflow Summary
        if: always()
        run: |
          echo "# ðŸ“Š S3 Sync Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Workflow Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow Run:** [${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger Type:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "- **Deployment Reason:** ${{ github.event.inputs.reason }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **S3 Bucket:** \`${{ env.S3_BUCKET }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Region:** \`ap-southeast-1\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.sync.outputs.sync_status }}" == "success" ]; then
            echo "## âœ… Sync Status: SUCCESS" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Sync Status: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ðŸ“ Full Workflow Log" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat workflow.log >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ðŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- [S3 Bucket Console](https://s3.console.aws.amazon.com/s3/buckets/${{ env.S3_BUCKET }})" >> $GITHUB_STEP_SUMMARY
          echo "- [View Website](https://${{ env.S3_BUCKET }}.s3.ap-southeast-1.amazonaws.com/index.html)" >> $GITHUB_STEP_SUMMARY
